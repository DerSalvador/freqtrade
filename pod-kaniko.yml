apiVersion: v1
kind: Pod
metadata:
  name: kaniko
  labels:
    app: kaniko
spec:
  containers:
  - name: kaniko
    image: gcr.io/kaniko-project/executor:v1.9.2 # gcr.io/kaniko-project/executor:latest
    # args: [ "--dockerfile=./Dockerfile", "--context=/tmp/freqtrade", "--destination=registry.digitalocean.com/do-dersalvador-registry/freqtrade:2023.8_freqairlds", "--force", "--single-snapshot", "--use-new-run", "--snapshot-mode=redo" ]
    args: [ "--dockerfile=./Dockerfile", "--context=/tmp/freqtrade", "--destination=registry.digitalocean.com/do-dersalvador-registry/freqtrade:2023.8_freqairlds", "--force" ]
    volumeMounts:
      - name: docker-config
        mountPath: /kaniko/.docker
      - name: docker-config
        mountPath: /root/.docker
      - name: clonerepo
        mountPath: /tmp/freqtrade
  restartPolicy: Never
  initContainers:
    - image: python
      name: clonerepo
      command: ["/bin/sh"]
      args: ["-c", "mkdir /root/.ssh/; cp /tmp/sshkey/id_rsa /root/.ssh/id_rsa; chmod 0600 /root/.ssh/id_rsa; GIT_SSH_COMMAND='ssh -i /root/.ssh/id_rsa -o StrictHostKeyChecking=no' git clone git@github.com:DerSalvador/freqtrade.git --single-branch --branch 2023.8-freqtrade /tmp/freqtrade; echo finished cloning"] 
      volumeMounts:
      - name: clonerepo
        mountPath: /tmp/freqtrade
      - name: sshkey
        mountPath: /tmp/sshkey
  restartPolicy: Never
  volumes:
    - name: sshkey
      configMap:
        name: sshkey
    - name: docker-config
      configMap:
        name: brokerme-docker-registry-config
    - name: clonerepo
      emptyDir: {}
